 SELECT
      sc.id_connector_history AS connector,
      ac.category_type,
      CASE ac.category_type
          WHEN 0 THEN 'EQUITIES'
          WHEN 1 THEN 'FIXED_INCOME'
          WHEN 2 THEN 'MONEY_MARKET'
          WHEN 3 THEN 'COMMODITIES'
          WHEN 4 THEN 'REAL_ESTATE'
          WHEN 5 THEN 'MULTI_ASSET'
          WHEN 6 THEN 'CONVERTIBLE_BOND'
          WHEN 7 THEN 'CREDIT_DERIVATIVE'
          WHEN 8 THEN 'CURRENCY_PAIR'
      END AS category_name,
      ac.spec_invest_instrument,
      CASE ac.spec_invest_instrument
          WHEN 0 THEN 'DIRECT'
          WHEN 1 THEN 'ETF'
          WHEN 2 THEN 'MUTUAL_FUND'
          WHEN 3 THEN 'PENSION_FUNDS'
          WHEN 4 THEN 'CFD'
          WHEN 5 THEN 'FOREX'
          WHEN 6 THEN 'ISSUER_RISK_PRODUCT'
          WHEN 7 THEN 'LEVERAGED_PRODUCT'
          WHEN 8 THEN 'NON_INVESTABLE_INDICES'
          ELSE 'UNKNOWN'
      END AS instrument_name,
      COUNT(DISTINCT s.id_securitycurrency) AS total_securities,
      COUNT(DISTINCT CASE
          WHEN hq.open IS NULL AND hq.high IS NULL AND hq.low IS NULL
          THEN s.id_securitycurrency
      END) AS securities_close_only,
      COUNT(*) AS total_quotes,
      SUM(CASE WHEN hq.open IS NULL AND hq.high IS NULL AND hq.low IS NULL THEN 1 ELSE 0 END) AS close_only_quotes,
      SUM(CASE WHEN hq.open IS NOT NULL AND hq.high IS NOT NULL AND hq.low IS NOT NULL THEN 1 ELSE 0 END) AS ohlc_quotes,
      ROUND(SUM(CASE WHEN hq.open IS NULL AND hq.high IS NULL AND hq.low IS NULL THEN 1 ELSE 0 END) / COUNT(*) * 100, 2) AS close_only_pct
  FROM historyquote hq
  JOIN securitycurrency sc ON hq.id_securitycurrency = sc.id_securitycurrency
  JOIN security s ON sc.id_securitycurrency = s.id_securitycurrency
  JOIN assetclass ac ON s.id_asset_class = ac.id_asset_class
  WHERE sc.id_connector_history IS NOT NULL
  GROUP BY sc.id_connector_history, ac.category_type, ac.spec_invest_instrument
  HAVING close_only_quotes / total_quotes > 0.10
  ORDER BY sc.id_connector_history, ac.category_type, ac.spec_invest_instrument;