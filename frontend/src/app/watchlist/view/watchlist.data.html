<!--
   Watchlist data table view using configurable-table component.
   This template is shared across multiple watchlist types: PERFORMANCE, PRICE_FEED, UDF, and DIVIDEND_SPLIT_FEED.
   Each type displays different columns and expanded row content.
-->

<configurable-table
  [data]="securityPositionList"
  [fields]="fields"
  [dataKey]="'securitycurrency.idSecuritycurrency'"
  [selectionMode]="selectMultiMode"
  [(selection)]="singleMultiSelection"
  [multiSortMeta]="multiSortMeta"
  [customSortFn]="customSort.bind(this)"
  [scrollHeight]="'flex'"
  [scrollable]="true"
  [stripedRows]="true"
  [showGridlines]="true"
  [loading]="loading"
  [containerClass]="{'data-container': true, 'active-border': isActivated(), 'passiv-border': !isActivated()}"
  [expandable]="true"
  [expandedRowTemplate]="expandedContent"
  [canExpandFn]="canExpandRow.bind(this)"
  [showContextMenu]="contextMenuItems && isActivated()"
  [contextMenuItems]="contextMenuItems"
  [ownerHighlightFn]="ownerHighlightFn.bind(this)"
  [negativeValueFn]="isValueByPathMinus.bind(this)"
  [valueGetterFn]="getValueByPath.bind(this)"
  (componentClick)="onComponentClick($event)"
  (colResize)="onColResize($event)">

  <!-- Caption -->
  <h4 caption>{{ 'WATCHLIST' | translate }}: "{{ watchlist.name }}" {{
    securitycurrencyGroup?.lastTimestamp | date: 'HH:mm dd.MM.yy'
  }}</h4>

  <!-- Custom icon cell template for svg-icon rendering with drag-and-drop -->
  <ng-template #iconCell let-row let-field="field" let-value="value">
    <svg-icon
      [name]="value"
      [svgStyle]="{ 'width.px':14, 'height.px':14 }"
      [pTooltip]="row.securitycurrency.idSecuritycurrency"
      class="cell-move"
      draggable="true"
      (dragstart)="dragStart($event, row)"
      (dragend)="dragEnd($event, row)">
    </svg-icon>
  </ng-template>

  <!-- Custom link icon cell template -->
  <ng-template #linkIconCell let-row let-field="field">
    <svg-icon
      [name]="'link' + (field.field.match(fieldNumberRegex) % 4)"
      [svgStyle]="{ 'width.px':24, 'height.px':14 }">
    </svg-icon>
  </ng-template>

</configurable-table>

<!-- Expanded row content template -->
<ng-template #expandedContent let-row>
  @if (row.watchlistSecurityHasEver || watchlistType !== WatchListType.PERFORMANCE) {
    @if (watchlistType === WatchListType.PERFORMANCE && !isMarginProduct(row)) {
      <transaction-security-table
        (dateChanged)="handleCloseTransactionDialog($event)"
        [idSecuritycurrency]="row.securitycurrency.idSecuritycurrency"
        [idTenant]="idTenant">
      </transaction-security-table>
    }

    @if (watchlistType === WatchListType.PERFORMANCE && isMarginProduct(row)) {
      <transaction-security-margin-treetable
        (dateChanged)="handleCloseTransactionDialog($event)"
        [idSecuritycurrency]="row.securitycurrency.idSecuritycurrency"
        [idTenant]="idTenant">
      </transaction-security-margin-treetable>
    }

    @if (watchlistType === WatchListType.UDF) {
      <securitycurrency-udf [securitycurrency]="row.securitycurrency">
      </securitycurrency-udf>
    }

    @if (watchlistType === WatchListType.PRICE_FEED) {
      <securitycurrency-extended-info
        [dividendUrl]="row.dividendUrl"
        [splitUrl]="row.splitUrl"
        [historicalUrl]="row.historicalUrl"
        [intradayUrl]="row.intradayUrl"
        [feedConnectorsKV]="feedConnectorsKV"
        [securitycurrency]="row.securitycurrency">
      </securitycurrency-extended-info>
    }

    @if (watchlistType === WatchListType.DIVIDEND_SPLIT_FEED) {
      <div>
        <watchlist-dividend-table [idSecuritycurrency]="row.securitycurrency.idSecuritycurrency">
        </watchlist-dividend-table>
        <watchlist-securitysplit-table [idSecuritycurrency]="row.securitycurrency.idSecuritycurrency">
        </watchlist-securitysplit-table>
      </div>
    }
  }
</ng-template>

<!-- Dialog Components (unchanged) -->
@if (visibleSecurityTransactionDialog) {
  <transaction-security-edit (closeDialog)="handleCloseTransactionDialog($event)"
                             [transactionCallParam]="transactionCallParam"
                             [visibleSecurityTransactionDialog]="visibleSecurityTransactionDialog">
  </transaction-security-edit>
}

@if (visibleAddInstrumentDialog) {
  <watchlist-add-instrument (closeDialog)="handleCloseAddInstrumentDialog($event)"
                            [idWatchlist]="idWatchlist"
                            [tenantLimits]="tenantLimits"
                            [visibleAddInstrumentDialog]="visibleAddInstrumentDialog">
  </watchlist-add-instrument>
}

@if (visibleEditCurrencypairDialog) {
  <currencypair-edit (closeDialog)="handleCloseEditSecuritycurrencyDialog($event)"
                     [securityCurrencypairCallParam]="securityCurrencypairCallParam"
                     [visibleEditCurrencypairDialog]="visibleEditCurrencypairDialog">
  </currencypair-edit>
}

@if (visibleEditSecurityDialog) {
  <security-edit (closeDialog)="handleCloseEditSecuritycurrencyDialog($event)"
                 [securityCurrencypairCallParam]="securityCurrencypairCallParam"
                 [visibleEditSecurityDialog]="visibleEditSecurityDialog">
  </security-edit>
}

@if (visibleEditSecurityDerivedDialog) {
  <security-derived-edit (closeDialog)="handleCloseEditSecuritycurrencyDialog($event)"
                         [securityCallParam]="securityCallParam"
                         [visibleDialog]="visibleEditSecurityDerivedDialog">
  </security-derived-edit>
}

@if (visibleUDFSecurityDialog) {
  <udf-security-edit (closeDialog)="handleCloseEditSecuritycurrencyDialog($event)"
                     [uDFGeneralCallParam]="uDFGeneralCallParam"
                     [visibleDialog]="visibleUDFSecurityDialog">
  </udf-security-edit>
}

@if (alarmSetupService.visibleDialog) {
  <algo-strategy-edit [visibleDialog]="alarmSetupService.visibleDialog"
                      [algoCallParam]="alarmSetupService.algoCallParam"
                      (closeDialog)="alarmSetupService.handleCloseDialog($event)">
  </algo-strategy-edit>
}

@if (visibleUDFGeneralDialog) {
  <udf-general-edit (closeDialog)="handleCloseEditSecuritycurrencyDialog($event)"
                    [uDFGeneralCallParam]="uDFGeneralCallParam"
                    [visibleDialog]="visibleUDFGeneralDialog">
  </udf-general-edit>
}

@if (watchlistType === WatchListType.PRICE_FEED && visibleAddPriceProblemDialog) {
  <watchlist-add-edit-price-problem-instrument (closeDialog)="handleCloseAddPriceProblemInstrument($event)"
                                               [idWatchlist]="idWatchlist"
                                               [visibleDialog]="visibleAddPriceProblemDialog">
  </watchlist-add-edit-price-problem-instrument>
}
