-- GTNet message deletion retention configuration
-- LP = LastPrice message codes (60, 61) retention in days
-- HP = HistoryPrice message codes (80, 81) retention in days
-- Valid range for both: 1-10 days
DELETE FROM globalparameters WHERE property_name = 'gt.gtnet.del.message.recv';
INSERT INTO globalparameters(property_name, property_string, changed_by_system, input_rule)
VALUES ('gt.gtnet.del.message.recv', 'LP=1,HP=5', 0, 'pattern:^LP=([1-9]|10),HP=([1-9]|10)$');

-- GTNet log aggregation days configuration
-- D = Days before aggregating INDIVIDUAL to DAILY
-- W = Days before aggregating DAILY to WEEKLY
-- M = Days before aggregating WEEKLY to MONTHLY
-- Y = Days before aggregating MONTHLY to YEARLY
DELETE FROM globalparameters WHERE property_name = 'gt.gtnet.log.aggregate.days';
INSERT INTO globalparameters(property_name, property_string, changed_by_system, input_rule)
VALUES ('gt.gtnet.log.aggregate.days', 'D=1,W=7,M=30,Y=365', 0, 'pattern:^D=\\d+,W=\\d+,M=\\d+,Y=\\d+$');


UPDATE globalparameters SET input_rule = 'pattern:^[A-Z]{3}=[0-8](,[A-Z]{3}=[0-8])*$'
WHERE property_name = 'gt.currency.precision';

  
-- Remove id_gt_net column from gt_net_instrument table
-- This column was redundant because each PUSH_OPEN instance has only one instrument pool
-- and all instruments belong to the local "myGtNet" entry

-- Check and drop foreign key constraint if it exists
SET @fk_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND CONSTRAINT_NAME = 'FK_GtNetInstrument_GtNet');

SET @sql = IF(@fk_exists > 0,
    'ALTER TABLE gt_net_instrument DROP FOREIGN KEY FK_GtNetInstrument_GtNet',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- Check and drop index if it exists
SET @idx_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.STATISTICS
    WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND INDEX_NAME = 'FK_GtNetInstrument_GtNet');

SET @sql = IF(@idx_exists > 0,
    'ALTER TABLE gt_net_instrument DROP INDEX FK_GtNetInstrument_GtNet',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- Check and drop column if it exists
SET @col_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND COLUMN_NAME = 'id_gt_net');

SET @sql = IF(@col_exists > 0,
    'ALTER TABLE gt_net_instrument DROP COLUMN id_gt_net',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  

-- Remove id_gt_net column from gt_net_instrument table
-- This column was redundant because each PUSH_OPEN instance has only one instrument pool
-- and all instruments belong to the local "myGtNet" entry

-- Check and drop foreign key constraint if it exists
SET @fk_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND CONSTRAINT_NAME = 'FK_GtNetInstrument_GtNet');

SET @sql = IF(@fk_exists > 0,
    'ALTER TABLE gt_net_instrument DROP FOREIGN KEY FK_GtNetInstrument_GtNet',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- Check and drop index if it exists
SET @idx_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.STATISTICS
    WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND INDEX_NAME = 'FK_GtNetInstrument_GtNet');

SET @sql = IF(@idx_exists > 0,
    'ALTER TABLE gt_net_instrument DROP INDEX FK_GtNetInstrument_GtNet',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

-- Check and drop column if it exists
SET @col_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'gt_net_instrument'
    AND COLUMN_NAME = 'id_gt_net');

SET @sql = IF(@col_exists > 0,
    'ALTER TABLE gt_net_instrument DROP COLUMN id_gt_net',
    'SELECT 1');

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
