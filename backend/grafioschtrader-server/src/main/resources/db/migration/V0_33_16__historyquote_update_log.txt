UPDATE globalparameters SET property_name = 'g.gnet.my.entry.id' WHERE property_name = 'gt.gtnet.my.entry.id';
UPDATE globalparameters SET property_name = 'g.gnet.use' WHERE property_name = 'gt.gtnet.use';
UPDATE globalparameters SET property_name = 'g.gnet.use.log' WHERE property_name = 'gt.gtnet.use.log';


DROP TABLE IF EXISTS historyquote_update_log;

CREATE TABLE `historyquote_update_log` (
  `id_hq_update_log` INT(11) NOT NULL AUTO_INCREMENT,
  `id_stockexchange` INT(11) NOT NULL,
  `update_timestamp` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `minutes_since_close` INT(11) NOT NULL,
  `securities_count` INT(11) NOT NULL,
  `securities_updated` INT(11) NOT NULL DEFAULT 0,
  `update_status` TINYINT(1) NOT NULL DEFAULT 0,
  `error_message` VARCHAR(500) DEFAULT NULL,
  PRIMARY KEY (`id_hq_update_log`),
  KEY `idx_hq_update_stockexchange` (`id_stockexchange`),
  KEY `idx_hq_update_timestamp` (`update_timestamp`),
  CONSTRAINT `fk_hq_update_stockexchange` FOREIGN KEY (`id_stockexchange`)
    REFERENCES `stockexchange` (`id_stockexchange`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;



-- GTNet Security Import tables for organizing bulk security lookups
DROP TABLE IF EXISTS gt_net_security_imp_gap;
DROP TABLE IF EXISTS gt_net_security_imp_pos;
DROP TABLE IF EXISTS gt_net_security_imp_head;

-- Header table for grouping security import positions
CREATE TABLE gt_net_security_imp_head (
    id_gt_net_security_imp_head INT AUTO_INCREMENT PRIMARY KEY,
    id_tenant INT NOT NULL,
    name VARCHAR(40) NOT NULL,
    note VARCHAR(1000),
    CONSTRAINT fk_gt_net_sec_imp_head_tenant FOREIGN KEY (id_tenant) REFERENCES tenant(id_tenant)
);

-- Position table for individual securities to import
CREATE TABLE gt_net_security_imp_pos (
    id_gt_net_security_imp_pos INT AUTO_INCREMENT PRIMARY KEY,
    id_gt_net_security_imp_head INT NOT NULL,
    isin VARCHAR(12),
    ticker_symbol VARCHAR(6),
    currency VARCHAR(3) NOT NULL,
    id_securitycurrency INT,
    CONSTRAINT fk_gt_net_sec_imp_pos_head FOREIGN KEY (id_gt_net_security_imp_head)
        REFERENCES gt_net_security_imp_head(id_gt_net_security_imp_head) ON DELETE CASCADE,
    CONSTRAINT fk_gt_net_sec_imp_pos_security FOREIGN KEY (id_securitycurrency)
        REFERENCES security(id_securitycurrency) ON DELETE SET NULL
);


-- Create table for recording import gaps when GTNet security matching fails
CREATE TABLE `gt_net_security_imp_gap` (
  `id_gt_net_security_imp_gap` int(11) NOT NULL AUTO_INCREMENT,
  `id_gt_net_security_imp_pos` int(11) NOT NULL,
  `id_gt_net` int(11) NOT NULL,
  `gap_code` tinyint(2) NOT NULL,
  `gap_message` varchar(1000) NOT NULL,
  PRIMARY KEY (`id_gt_net_security_imp_gap`),
  KEY `FK_GTNetSecurityImpGap_GTNetSecurityImpPos` (`id_gt_net_security_imp_pos`),
  KEY `FK_GTNetSecurityImpGap_GTNet` (`id_gt_net`),
  CONSTRAINT `FK_GTNetSecurityImpGap_GTNetSecurityImpPos`
    FOREIGN KEY (`id_gt_net_security_imp_pos`)
    REFERENCES `gt_net_security_imp_pos` (`id_gt_net_security_imp_pos`) ON DELETE CASCADE,
  CONSTRAINT `FK_GTNetSecurityImpGap_GTNet`
    FOREIGN KEY (`id_gt_net`)
    REFERENCES `gt_net` (`id_gt_net`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



-- Add visibility column for admin-to-admin messaging in GTNet
-- Visibility: 0 = ALL_USERS (default), 1 = ADMIN_ONLY
ALTER TABLE gt_net_message DROP COLUMN IF EXISTS visibility;
ALTER TABLE gt_net_message ADD COLUMN visibility TINYINT(1) NOT NULL DEFAULT 0 AFTER message;

DELIMITER //

-- We use a Stored Procedure to handle the conditional logic, 
-- as MariaDB doesn't support 'IF EXISTS' for Constraints and Indexes.
CREATE OR REPLACE PROCEDURE DropConstraintsSafe()
BEGIN
    -- 1. Drop Foreign Key if it exists
    -- We check the information_schema to see if the constraint is active
    IF EXISTS (
        SELECT 1 FROM information_schema.TABLE_CONSTRAINTS 
        WHERE CONSTRAINT_SCHEMA = DATABASE() 
        AND TABLE_NAME = 'mail_send_recv' 
        AND CONSTRAINT_NAME = 'FK_MailSendRecv_GtNet' 
        AND CONSTRAINT_TYPE = 'FOREIGN KEY'
    ) THEN
        ALTER TABLE mail_send_recv DROP FOREIGN KEY FK_MailSendRecv_GtNet;
    END IF;

    -- 2. Drop Index if it exists
    -- Statistics table stores information about all indexes
    IF EXISTS (
        SELECT 1 FROM information_schema.STATISTICS 
        WHERE TABLE_SCHEMA = DATABASE() 
        AND TABLE_NAME = 'mail_send_recv' 
        AND INDEX_NAME = 'FK_MailInOut_GtNet'
    ) THEN
        ALTER TABLE mail_send_recv DROP INDEX FK_MailInOut_GtNet;
    END IF;
END //

DELIMITER ;

-- Execute the logic defined above
CALL DropConstraintsSafe();

-- Clean up: Remove the procedure after execution
DROP PROCEDURE IF EXISTS DropConstraintsSafe;

-- 3. Drop the column if it exists
-- This syntax is natively supported in MariaDB 10.0.2+
ALTER TABLE mail_send_recv DROP COLUMN IF EXISTS id_gt_net;

DELETE FROM globalparameters WHERE property_name = 'gt.limit.day.Security';
INSERT INTO globalparameters (property_name, property_int) VALUES ('gt.limit.day.Security', 50);
