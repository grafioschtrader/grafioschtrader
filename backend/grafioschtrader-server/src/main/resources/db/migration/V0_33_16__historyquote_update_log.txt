UPDATE globalparameters SET property_name = 'g.gnet.my.entry.id' WHERE property_name = 'gt.gtnet.my.entry.id';
UPDATE globalparameters SET property_name = 'g.gnet.use' WHERE property_name = 'gt.gtnet.use';
UPDATE globalparameters SET property_name = 'g.gnet.use.log' WHERE property_name = 'gt.gtnet.use.log';


DROP TABLE IF EXISTS historyquote_update_log;

CREATE TABLE `historyquote_update_log` (
  `id_hq_update_log` INT(11) NOT NULL AUTO_INCREMENT,
  `id_stockexchange` INT(11) NOT NULL,
  `update_timestamp` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `minutes_since_close` INT(11) NOT NULL,
  `securities_count` INT(11) NOT NULL,
  `securities_updated` INT(11) NOT NULL DEFAULT 0,
  `update_status` TINYINT(1) NOT NULL DEFAULT 0,
  `error_message` VARCHAR(500) DEFAULT NULL,
  PRIMARY KEY (`id_hq_update_log`),
  KEY `idx_hq_update_stockexchange` (`id_stockexchange`),
  KEY `idx_hq_update_timestamp` (`update_timestamp`),
  CONSTRAINT `fk_hq_update_stockexchange` FOREIGN KEY (`id_stockexchange`)
    REFERENCES `stockexchange` (`id_stockexchange`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;



-- GTNet Security Import tables for organizing bulk security lookups
DROP TABLE IF EXISTS gt_net_security_imp_gap;
DROP TABLE IF EXISTS gt_net_security_imp_pos;
DROP TABLE IF EXISTS gt_net_security_imp_head;

-- Header table for grouping security import positions
CREATE TABLE gt_net_security_imp_head (
    id_gt_net_security_imp_head INT AUTO_INCREMENT PRIMARY KEY,
    id_tenant INT NOT NULL,
    name VARCHAR(40) NOT NULL,
    note VARCHAR(1000),
    CONSTRAINT fk_gt_net_sec_imp_head_tenant FOREIGN KEY (id_tenant) REFERENCES tenant(id_tenant)
);

-- Position table for individual securities to import
CREATE TABLE gt_net_security_imp_pos (
    id_gt_net_security_imp_pos INT AUTO_INCREMENT PRIMARY KEY,
    id_gt_net_security_imp_head INT NOT NULL,
    isin VARCHAR(12),
    ticker_symbol VARCHAR(6),
    currency VARCHAR(3) NOT NULL,
    id_securitycurrency INT,
    CONSTRAINT fk_gt_net_sec_imp_pos_head FOREIGN KEY (id_gt_net_security_imp_head)
        REFERENCES gt_net_security_imp_head(id_gt_net_security_imp_head) ON DELETE CASCADE,
    CONSTRAINT fk_gt_net_sec_imp_pos_security FOREIGN KEY (id_securitycurrency)
        REFERENCES security(id_securitycurrency) ON DELETE SET NULL
);


-- Create table for recording import gaps when GTNet security matching fails
CREATE TABLE `gt_net_security_imp_gap` (
  `id_gt_net_security_imp_gap` int(11) NOT NULL AUTO_INCREMENT,
  `id_gt_net_security_imp_pos` int(11) NOT NULL,
  `id_gt_net` int(11) NOT NULL,
  `gap_code` tinyint(2) NOT NULL,
  `gap_message` varchar(1000) NOT NULL,
  PRIMARY KEY (`id_gt_net_security_imp_gap`),
  KEY `FK_GTNetSecurityImpGap_GTNetSecurityImpPos` (`id_gt_net_security_imp_pos`),
  KEY `FK_GTNetSecurityImpGap_GTNet` (`id_gt_net`),
  CONSTRAINT `FK_GTNetSecurityImpGap_GTNetSecurityImpPos`
    FOREIGN KEY (`id_gt_net_security_imp_pos`)
    REFERENCES `gt_net_security_imp_pos` (`id_gt_net_security_imp_pos`) ON DELETE CASCADE,
  CONSTRAINT `FK_GTNetSecurityImpGap_GTNet`
    FOREIGN KEY (`id_gt_net`)
    REFERENCES `gt_net` (`id_gt_net`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
